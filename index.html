<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buscador de Consumibles e Impresoras</title>
  <style>
    :root {
      --bg-search: #ffffff;
      --bg-cons: #e3f2fd;
      --bg-print: #e8f5e9;
      --border-radius: 8px;
      --padding: 1rem;
      --font: 'Segoe UI', sans-serif;
    }
    body { margin:0; padding:2rem; font-family: var(--font); background:#f5f5f5; }
    .search-container { display:flex; justify-content:center; margin-bottom:1.5rem; }
    #search { width:60%; padding:0.75rem; font-size:1rem; border:1px solid #ccc; border-radius:var(--border-radius); }
    .suggestions { position:absolute; background:#fff; width:60%; max-height:150px; overflow-y:auto; border:1px solid #ccc; border-radius:0 0 var(--border-radius) var(--border-radius); }
    .suggestions div { padding:0.5rem; cursor:pointer; }
    .suggestions div:hover { background:#eee; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:1rem; }
    .box { background:#fff; padding:var(--padding); border-radius:var(--border-radius); }
    .box h2 { margin-top:0; font-size:1.2rem; }
    #imageBox { text-align:center; }
    #imageBox img { max-width:100%; height:auto; border-radius:var(--border-radius); }
    .item-list { list-style:none; padding:0; margin:0; }
    .item-list li { margin-bottom:0.5rem; }
    .item-list li strong { display:inline-block; width:100px; }
  </style>
</head>
<body>
  <div class="search-container">
    <input type="text" id="search" placeholder="Buscar por referencia o nombre...">
    <div id="suggestions" class="suggestions"></div>
  </div>
  <div class="grid">
    <div class="box" style="background: var(--bg-search)">
      <h2>Imagen</h2>
      <div id="imageBox"><p>Sin selecci贸n</p></div>
    </div>
    <div class="box" style="background: var(--bg-cons)">
      <h2>Consumibles relacionados</h2>
      <ul id="consBox" class="item-list"><li>Sin selecci贸n</li></ul>
    </div>
    <div class="box" style="background: var(--bg-print)">
      <h2>Impresoras relacionadas</h2>
      <ul id="printBox" class="item-list"><li>Sin selecci贸n</li></ul>
    </div>
  </div>

  <script>
    let dataset = [];
    async function cargarDatos() {
      try {
        const res = await fetch('compatibilidades_cartuchos.json');
        if (!res.ok) throw new Error('JSON no encontrado');
        dataset = await res.json();
      } catch (e) {
        console.error(e);
        alert('Error cargando datos');
      }
    }
    cargarDatos();

    const normalize = s => s.toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/[^a-z0-9]+/g,' ').trim();

    const searchInput = document.getElementById('search');
    const suggestions = document.getElementById('suggestions');

    searchInput.addEventListener('input', ()=>{
      const v = normalize(searchInput.value);
      suggestions.innerHTML = '';
      if (v.length<2) return;
      const matches = [];
      // sugerir por consumibles
      dataset.forEach(item=>{
        if (normalize(item.referencia).includes(v) || normalize(item.nombre).includes(v))
          matches.push(item);
      });
      // sugerir impresoras
      dataset.forEach(item=>{
        item.compatibles.forEach(p=>{
          if (normalize(p).includes(v)) {
            // crear objeto temporal para impresi贸n
            matches.push({nombre:p,referencia:'',imagen:'',descripcion:'',compatibles:[]});
          }
        });
      });
      const unique = Array.from(new Map(matches.map(i=>[i.nombre+i.referencia,i])).values()).slice(0,8);
      unique.forEach(it=>{
        const d = document.createElement('div');
        d.textContent = it.nombre || it.referencia;
        d.onclick = ()=> selectItem(it);
        suggestions.appendChild(d);
      });
    });

    function selectItem(item) {
      suggestions.innerHTML='';
      searchInput.value = item.nombre||item.referencia;
      mostrar(item);
    }

    function mostrar(item) {
      // Imagen
      const imgBox = document.getElementById('imageBox');
      if (item.imagen) imgBox.innerHTML = `<img src="${item.imagen}" onerror="this.src='https://via.placeholder.com/200?text=Sin+imagen'"/>`;
      else imgBox.innerHTML = '<p>Sin imagen</p>';
      // Consumibles relacionados (si item es impresora)
      const cons = document.getElementById('consBox'); cons.innerHTML='';
      let consumibles = [];
      // si tiene compatibles -> item es consumible, mostrar compatibles impresoras aparte abajo
      if (item.compatibles && item.compatibles.length) {
        // mostrar el consumible busca impresoras
      }
      // imprimibles: buscar consumibles que incluyan esta impresora
      dataset.forEach(it=>{
        if (it.compatibles.includes(item.referencia) || it.compatibles.includes(item.nombre)) consumibles.push(it);
      });
      consumibles.forEach(c=>{
        const li = document.createElement('li');
        li.innerHTML = `<strong>${c.referencia}</strong> ${c.nombre}`;
        cons.appendChild(li);
      });
      if(!consumibles.length) cons.innerHTML='<li>Sin consumibles</li>';

      // Impresoras relacionados
      const prints = document.getElementById('printBox'); prints.innerHTML='';
      let printers=[];
      if (item.compatibles && item.compatibles.length) {
        // item is consumible, compatibles are printers
        printers = item.compatibles.map(p=>({nombre:p}));
      } else {
        // no compatibles: item likely printer, compatibles arriba
      }
      printers.forEach(p=>{
        const li = document.createElement('li'); li.textContent = p.nombre;
        prints.appendChild(li);
      });
      if (!printers.length) prints.innerHTML='<li>Sin impresoras</li>';
    }
  </script>
</body>
</html>
