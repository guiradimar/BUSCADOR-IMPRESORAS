<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Convertidor CSV a JSON con Compatibles</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; background: #f9f9f9; }
    label { display: block; margin-bottom: .5rem; }
    input, button { padding: .5rem; margin-bottom: 1rem; }
    button { cursor: pointer; }
    pre { background: #fff; padding: 1rem; border: 1px solid #ddd; max-height: 300px; overflow: auto; }
  </style>
</head>
<body>
  <h1>Convertidor CSV → JSON (con consumibles compatibles)</h1>
  <label for="fileInput">Selecciona tu CSV (delimitado por `;`):</label>
  <input type="file" id="fileInput" accept=".csv" />
  <button id="convertBtn" disabled>Convertir a JSON</button>
  <a id="downloadLink" style="display:none; margin-left: 1rem;">Descargar JSON</a>
  <h2>Vista previa JSON</h2>
  <pre id="output"></pre>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const fileInput = document.getElementById('fileInput');
    const convertBtn = document.getElementById('convertBtn');
    const output = document.getElementById('output');
    const dlLink = document.getElementById('downloadLink');

    let rows = [];

    fileInput.addEventListener('change', () => {
      if (fileInput.files.length) convertBtn.disabled = false;
    });

    convertBtn.addEventListener('click', () => {
      convertBtn.disabled = true;
      Papa.parse(fileInput.files[0], {
        header: true,
        delimiter: ';',
        skipEmptyLines: true,
        complete: results => {
          rows = results.data;
          // Generar mapa código → consumibles
          const map = {};
          rows.forEach(r => {
            const comps = (r.COMPATIBILIDADES|| '').split(/,|>/).map(x=>x.trim()).filter(x=>x);
            comps.forEach(c => {
              map[c] = map[c] || new Set();
              if (r.NOMBRE) map[c].add(r.NOMBRE);
            });
          });
          // Añadir array consumibles_compatibles a cada row
          const processed = rows.map(r => {
            const comps = (r.COMPATIBILIDADES|| '').split(/,|>/).map(x=>x.trim()).filter(x=>x);
            const compatibles = Array.from(new Set(comps.flatMap(c => Array.from(map[c]||[]))));
            return {...r, consumibles_compatibles: compatibles};
          });

          const json = { columns: Object.keys(processed[0]||{}), rows: processed };
          const str = JSON.stringify(json, null, 2);
          output.textContent = str;

          // Crear enlace de descarga
          const blob = new Blob([str], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          dlLink.href = url;
          dlLink.download = 'dataset_full_with_consumibles.json';
          dlLink.textContent = 'Descargar JSON';
          dlLink.style.display = 'inline-block';
          convertBtn.disabled = false;
        }
      });
    });
  </script>
</body>
</html>
