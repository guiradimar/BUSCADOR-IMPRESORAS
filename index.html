<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BUSCADOR CONSUMIBLES/IMPRESORAS</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f4f8;
      text-align: center;
    }

    h1 {
      color: #003366;
      margin: 30px 0 10px;
      font-size: 32px;
    }

    input {
      width: 60%;
      padding: 10px;
      font-size: 16px;
      margin: 10px auto;
      border-radius: 10px;
      border: 2px solid #3399ff;
    }

    .results {
      display: flex;
      justify-content: center;
      margin-top: 20px;
      gap: 20px;
      flex-wrap: wrap;
    }

    .box {
      width: 40%;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 0 10px #ccc;
      padding: 20px;
      text-align: left;
      min-width: 300px;
    }

    .consumibles {
      border-top: 5px solid #00aa88;
    }

    .impresoras {
      border-top: 5px solid #cc3333;
    }

    h2 {
      margin-top: 0;
      text-transform: uppercase;
    }

    .item {
      margin-bottom: 20px;
    }

    .google-button {
      margin-top: 30px;
      padding: 12px 24px;
      background-color: #007bff;
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      display: none;
    }
  </style>
</head>
<body>

  <h1>BUSCADOR CONSUMIBLES/IMPRESORAS</h1>
  <input type="text" id="searchBox" placeholder="Busca por marca, referencia, nombre, descripción, capacidad..." oninput="buscar()" />

  <div class="results">
    <div class="box consumibles">
      <h2>CONSUMIBLES</h2>
      <div id="consumiblesResult">No hay consumibles que coincidan.</div>
    </div>
    <div class="box impresoras">
      <h2>IMPRESORAS</h2>
      <div id="impresorasResult">No hay impresoras que coincidan.</div>
    </div>
  </div>

  <button class="google-button" id="googleBtn" onclick="buscarEnGoogle()">Buscar en Google</button>

  <script>
    let data = [];

    fetch('compatibilidades_completo.json')
      .then(res => res.json())
      .then(json => {
        data = json;
        console.log("JSON cargado con", data.length, "entradas");
      })
      .catch(err => {
        console.error("Error al cargar el JSON:", err);
      });

    function normalizar(texto) {
      return texto?.toLowerCase().replace(/\s+/g, '').replace(/[^\w\d]/g, '') || '';
    }

    function buscar() {
      const q = normalizar(document.getElementById("searchBox").value.trim());
      const consumiblesDiv = document.getElementById("consumiblesResult");
      const impresorasDiv = document.getElementById("impresorasResult");
      const googleBtn = document.getElementById("googleBtn");

      if (!q) {
        consumiblesDiv.innerHTML = "No hay consumibles que coincidan.";
        impresorasDiv.innerHTML = "No hay impresoras que coincidan.";
        googleBtn.style.display = "none";
        return;
      }

      const resultadosConsumibles = [];
      const resultadosImpresoras = new Set();

      data.forEach(entry => {
        const campos = [
          entry.NOMBRE, entry.REFERENCIA, entry.DESCRIPCION,
          entry.CAPACIDAD, entry.REFERENCIA_NORMALIZADA,
          entry.NOMBRE_NORMALIZADO
        ].join(' ').toLowerCase();

        const compat = (entry.COMPATIBILIDADES_NORMALIZADAS || '').toLowerCase();

        if (campos.includes(q) || compat.includes(q)) {
          resultadosConsumibles.push(entry);
          if (entry.COMPATIBILIDADES_NORMALIZADAS) {
            entry.COMPATIBILIDADES_NORMALIZADAS.split(',').forEach(modelo => {
              if (normalizar(modelo).includes(q)) {
                resultadosImpresoras.add(modelo.trim());
              }
            });
          }
        }
      });

      consumiblesDiv.innerHTML = resultadosConsumibles.length
        ? resultadosConsumibles.map(c =>
            `<div class="item">
              <strong>${c.NOMBRE}</strong><br>
              Marca: ${extraerMarca(c.NOMBRE)}<br>
              Ref: ${c.REFERENCIA}<br>
              Capacidad: ${c.CAPACIDAD || "N/D"}<br>
              Precio: ${c.PRECIO || "N/D"}<br>
              Descripción: ${c.DESCRIPCION}
            </div>`
          ).join('')
        : "No hay consumibles que coincidan.";

      impresorasDiv.innerHTML = resultadosImpresoras.size
        ? [...resultadosImpresoras].map(i => `<div class="item">${i}</div>`).join('')
        : "No hay impresoras que coincidan.";

      googleBtn.style.display = (resultadosConsumibles.length === 0 && resultadosImpresoras.size === 0) ? "inline-block" : "none";
    }

    function extraerMarca(nombre) {
      const match = nombre?.match(/^(HP|Canon|Epson|Brother|Xerox|Samsung)/i);
      return match ? match[0] : "Desconocida";
    }

    function buscarEnGoogle() {
      const q = document.getElementById("searchBox").value.trim();
      if (q) {
        window.open(`https://www.google.com/search?q=${encodeURIComponent(q)}`, '_blank');
      }
    }
  </script>
</body>
</html>
